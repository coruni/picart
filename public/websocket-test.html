<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket æ¶ˆæ¯é€šçŸ¥æµ‹è¯•</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 28px;
      margin-bottom: 10px;
    }

    .status {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 20px;
      background: rgba(255, 255, 255, 0.2);
      font-size: 14px;
    }

    .status.connected {
      background: #10b981;
    }

    .status.disconnected {
      background: #ef4444;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      padding: 30px;
    }

    .panel {
      background: #f9fafb;
      border-radius: 8px;
      padding: 20px;
    }

    .panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #1f2937;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      margin-bottom: 5px;
      color: #4b5563;
      font-size: 14px;
      font-weight: 500;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .button-group button {
      flex: 1;
      min-width: 120px;
    }

    .messages {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 15px;
    }

    .message {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: box-shadow 0.2s;
    }

    .message:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message.unread {
      border-left: 4px solid #667eea;
      background: #f0f4ff;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-sender {
      font-weight: 600;
      color: #1f2937;
    }

    .message-time {
      font-size: 12px;
      color: #9ca3af;
    }

    .message-content {
      color: #4b5563;
      line-height: 1.5;
      margin-bottom: 8px;
    }

    .message-type {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .message-type.private {
      background: #dbeafe;
      color: #1e40af;
    }

    .message-type.system {
      background: #fef3c7;
      color: #92400e;
    }

    .message-type.notification {
      background: #d1fae5;
      color: #065f46;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      border: 1px solid #e5e7eb;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 5px;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .log {
      background: #1f2937;
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.6;
    }

    .log-entry {
      margin-bottom: 5px;
    }

    .log-entry.error {
      color: #ef4444;
    }

    .log-entry.success {
      color: #10b981;
    }

    .log-entry.info {
      color: #60a5fa;
    }

    @media (max-width: 768px) {
      .content {
        grid-template-columns: 1fr;
      }

      .stats {
        grid-template-columns: 1fr;
      }
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: #667eea;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #5568d3;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ”” WebSocket æ¶ˆæ¯é€šçŸ¥æµ‹è¯•</h1>
      <div class="status" id="status">æœªè¿æ¥</div>
    </div>

    <div class="content">
      <!-- å·¦ä¾§ï¼šè¿æ¥å’Œå‘é€ -->
      <div>
        <!-- è¿æ¥é…ç½® -->
        <div class="panel">
          <h2>ğŸ”Œ è¿æ¥é…ç½®</h2>
          <div class="form-group">
            <label>WebSocket åœ°å€</label>
            <input type="text" id="wsUrl" value="ws://localhost:3000/ws-message" />
          </div>
          <div class="form-group">
            <label>JWT Token</label>
            <input type="text" id="token" placeholder="è¯·è¾“å…¥ JWT Token" />
          </div>
          <div class="button-group">
            <button onclick="connect()" id="connectBtn">è¿æ¥</button>
            <button onclick="disconnect()" id="disconnectBtn" disabled>æ–­å¼€</button>
          </div>
        </div>

        <!-- å‘é€æ¶ˆæ¯ -->
        <div class="panel">
          <h2>ğŸ“¤ å‘é€æ¶ˆæ¯</h2>
          <div class="form-group">
            <label>æ¥æ”¶è€…IDï¼ˆç•™ç©ºä¸ºå¹¿æ’­ï¼‰</label>
            <input type="number" id="receiverId" placeholder="æ¥æ”¶è€…ç”¨æˆ·ID" />
          </div>
          <div class="form-group">
            <label>æ¶ˆæ¯ç±»å‹</label>
            <select id="messageType">
              <option value="private">ç§ä¿¡</option>
              <option value="system">ç³»ç»Ÿæ¶ˆæ¯</option>
              <option value="notification">é€šçŸ¥</option>
            </select>
          </div>
          <div class="form-group">
            <label>æ¶ˆæ¯å†…å®¹</label>
            <textarea id="messageContent" placeholder="è¾“å…¥æ¶ˆæ¯å†…å®¹..."></textarea>
          </div>
          <button onclick="sendMessage()" id="sendBtn" disabled>å‘é€æ¶ˆæ¯</button>
        </div>

        <!-- æ“ä½œ -->
        <div class="panel">
          <h2>âš™ï¸ æ“ä½œ</h2>
          <div class="button-group">
            <button onclick="getHistory()" id="historyBtn" disabled>è·å–å†å²</button>
            <button onclick="getUnreadCount()" id="unreadBtn" disabled>æœªè¯»æ•°é‡</button>
            <button onclick="markAllAsRead()" id="markAllBtn" disabled>å…¨éƒ¨å·²è¯»</button>
            <button onclick="testPing()" id="pingBtn" disabled>Pingæµ‹è¯•</button>
          </div>
        </div>
      </div>

      <!-- å³ä¾§ï¼šæ¶ˆæ¯å’Œæ—¥å¿— -->
      <div>
        <!-- ç»Ÿè®¡ -->
        <div class="stats">
          <div class="stat-card">
            <div class="stat-value" id="totalMessages">0</div>
            <div class="stat-label">æ€»æ¶ˆæ¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="unreadMessages">0</div>
            <div class="stat-label">æœªè¯»æ¶ˆæ¯</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="broadcastMessages">0</div>
            <div class="stat-label">å¹¿æ’­æ¶ˆæ¯</div>
          </div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div class="panel">
          <h2>ğŸ’¬ æ¶ˆæ¯åˆ—è¡¨</h2>
          <div class="messages" id="messages">
            <p style="text-align: center; color: #9ca3af;">æš‚æ— æ¶ˆæ¯</p>
          </div>
        </div>

        <!-- æ—¥å¿— -->
        <div class="panel">
          <h2>ğŸ“‹ æ—¥å¿—</h2>
          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let socket = null;
    let messages = [];
    let unreadCount = 0;

    // æ·»åŠ æ—¥å¿—
    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const time = new Date().toLocaleTimeString();
      entry.textContent = `[${time}] ${message}`;
      logDiv.insertBefore(entry, logDiv.firstChild);
      
      // é™åˆ¶æ—¥å¿—æ•°é‡
      while (logDiv.children.length > 50) {
        logDiv.removeChild(logDiv.lastChild);
      }
    }

    // æ›´æ–°çŠ¶æ€
    function updateStatus(connected) {
      const statusEl = document.getElementById('status');
      const connectBtn = document.getElementById('connectBtn');
      const disconnectBtn = document.getElementById('disconnectBtn');
      const sendBtn = document.getElementById('sendBtn');
      const historyBtn = document.getElementById('historyBtn');
      const unreadBtn = document.getElementById('unreadBtn');
      const markAllBtn = document.getElementById('markAllBtn');
      const pingBtn = document.getElementById('pingBtn');

      if (connected) {
        statusEl.textContent = 'âœ… å·²è¿æ¥';
        statusEl.className = 'status connected';
        connectBtn.disabled = true;
        disconnectBtn.disabled = false;
        sendBtn.disabled = false;
        historyBtn.disabled = false;
        unreadBtn.disabled = false;
        markAllBtn.disabled = false;
        pingBtn.disabled = false;
      } else {
        statusEl.textContent = 'âŒ æœªè¿æ¥';
        statusEl.className = 'status disconnected';
        connectBtn.disabled = false;
        disconnectBtn.disabled = true;
        sendBtn.disabled = true;
        historyBtn.disabled = true;
        unreadBtn.disabled = true;
        markAllBtn.disabled = true;
        pingBtn.disabled = true;
      }
    }

    // è¿æ¥
    function connect() {
      const wsUrl = document.getElementById('wsUrl').value;
      const token = document.getElementById('token').value;

      if (!token) {
        alert('è¯·è¾“å…¥ JWT Token');
        return;
      }

      addLog('æ­£åœ¨è¿æ¥...', 'info');

      socket = io(wsUrl, {
        auth: { token },
        transports: ['websocket', 'polling']
      });

      // è¿æ¥æˆåŠŸ
      socket.on('connected', (data) => {
        addLog(`è¿æ¥æˆåŠŸ: ${JSON.stringify(data)}`, 'success');
        updateStatus(true);
        getUnreadCount();
      });

      // è¿æ¥é”™è¯¯
      socket.on('error', (error) => {
        addLog(`é”™è¯¯: ${error.message} (${error.code})`, 'error');
      });

      // æ–­å¼€è¿æ¥
      socket.on('disconnect', () => {
        addLog('è¿æ¥å·²æ–­å¼€', 'error');
        updateStatus(false);
      });

      // æ¥æ”¶æ–°æ¶ˆæ¯
      socket.on('newMessage', (message) => {
        addLog(`æ”¶åˆ°æ–°æ¶ˆæ¯: ${message.content}`, 'success');
        addMessage(message);
      });

      // æ¥æ”¶å†å²æ¶ˆæ¯
      socket.on('history', (data) => {
        addLog(`æ”¶åˆ°å†å²æ¶ˆæ¯: ${data.total} æ¡`, 'success');
        messages = data.items;
        renderMessages();
      });

      // æ¥æ”¶æœªè¯»æ•°é‡
      socket.on('unreadCount', (count) => {
        addLog(`æœªè¯»æ¶ˆæ¯: ä¸ªäºº ${count.personal}, å¹¿æ’­ ${count.broadcast}, æ€»è®¡ ${count.total}`, 'info');
        unreadCount = count.total;
        updateStats();
      });

      // Pong
      socket.on('pong', (data) => {
        addLog(`Pong: ${data.timestamp}`, 'info');
      });

      // å·²è¯»ç¡®è®¤
      socket.on('read', (data) => {
        addLog(`æ¶ˆæ¯ ${data.messageId} å·²æ ‡è®°ä¸ºå·²è¯»`, 'success');
      });

      // å…¨éƒ¨å·²è¯»ç¡®è®¤
      socket.on('allMarkedAsRead', (data) => {
        addLog('æ‰€æœ‰æ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»', 'success');
        getUnreadCount();
      });
    }

    // æ–­å¼€è¿æ¥
    function disconnect() {
      if (socket) {
        socket.close();
        socket = null;
        updateStatus(false);
        addLog('å·²æ–­å¼€è¿æ¥', 'info');
      }
    }

    // å‘é€æ¶ˆæ¯
    function sendMessage() {
      const receiverId = document.getElementById('receiverId').value;
      const content = document.getElementById('messageContent').value;
      const type = document.getElementById('messageType').value;

      if (!content) {
        alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹');
        return;
      }

      const data = {
        content,
        type,
        isBroadcast: !receiverId
      };

      if (receiverId) {
        data.toUserId = parseInt(receiverId);
      }

      socket.emit('sendMessage', data, (response) => {
        if (response.success) {
          addLog('æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
          document.getElementById('messageContent').value = '';
        } else {
          addLog('æ¶ˆæ¯å‘é€å¤±è´¥', 'error');
        }
      });
    }

    // è·å–å†å²æ¶ˆæ¯
    function getHistory() {
      socket.emit('getHistory', { page: 1, limit: 20 });
      addLog('æ­£åœ¨è·å–å†å²æ¶ˆæ¯...', 'info');
    }

    // è·å–æœªè¯»æ•°é‡
    function getUnreadCount() {
      socket.emit('getUnreadCount');
      addLog('æ­£åœ¨è·å–æœªè¯»æ•°é‡...', 'info');
    }

    // æ ‡è®°æ‰€æœ‰ä¸ºå·²è¯»
    function markAllAsRead() {
      socket.emit('markAllAsRead', {});
      addLog('æ­£åœ¨æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»...', 'info');
    }

    // Ping æµ‹è¯•
    function testPing() {
      socket.emit('ping');
      addLog('å‘é€ Ping...', 'info');
    }

    // æ·»åŠ æ¶ˆæ¯
    function addMessage(message) {
      messages.unshift(message);
      renderMessages();
      updateStats();
    }

    // æ¸²æŸ“æ¶ˆæ¯åˆ—è¡¨
    function renderMessages() {
      const messagesDiv = document.getElementById('messages');
      
      if (messages.length === 0) {
        messagesDiv.innerHTML = '<p style="text-align: center; color: #9ca3af;">æš‚æ— æ¶ˆæ¯</p>';
        return;
      }

      messagesDiv.innerHTML = messages.map(msg => `
        <div class="message ${!msg.isRead ? 'unread' : ''}">
          <div class="message-header">
            <span class="message-sender">${msg.sender?.nickname || msg.sender?.username || 'ç³»ç»Ÿ'}</span>
            <span class="message-time">${new Date(msg.createdAt).toLocaleString()}</span>
          </div>
          <div class="message-content">${msg.content}</div>
          <span class="message-type ${msg.type}">${msg.type}</span>
          ${msg.isBroadcast ? '<span class="message-type system">å¹¿æ’­</span>' : ''}
        </div>
      `).join('');

      updateStats();
    }

    // æ›´æ–°ç»Ÿè®¡
    function updateStats() {
      document.getElementById('totalMessages').textContent = messages.length;
      document.getElementById('unreadMessages').textContent = unreadCount;
      document.getElementById('broadcastMessages').textContent = 
        messages.filter(m => m.isBroadcast).length;
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', () => {
      addLog('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·è¾“å…¥ Token å¹¶è¿æ¥', 'info');
    });
  </script>
</body>
</html>
