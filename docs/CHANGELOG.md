# 更新日志

本文档记录项目的重要更新和变更。

## [2025-01-11] - 装饰品系统事件集成完成

### 新增
- ✨ **事件驱动的活动进度追踪**
  - 在文章点赞服务中添加 `article.liked` 事件触发
  - 在评论创建服务中添加 `comment.created` 事件触发
  - 装饰品活动进度自动追踪功能完全启用

### 技术实现
- 使用 EventEmitter2 实现事件驱动架构
- 点赞和评论操作自动触发装饰品活动进度更新
- 事件处理失败不影响主业务流程（异常捕获）

### 相关文件
- `src/modules/article/article.service.ts` - 添加点赞事件触发
- `src/modules/comment/comment.service.ts` - 添加评论事件触发
- `src/modules/decoration/decoration-event.service.ts` - 事件监听服务

---

## [2025-01-11] - 支付安全修复

### 修复
- 🔒 **修复余额为负的问题**
  - 使用数据库事务确保操作原子性
  - 使用悲观锁防止并发扣款
  - 添加双重余额检查
  - 错误时自动回滚

- 🔒 **修复退款逻辑**
  - 余额支付自动退款到用户余额
  - 使用事务确保退款安全
  - 记录详细的退款信息
  - 其他支付方式标记为待人工处理

- 🔒 **修复并发安全问题**
  - 使用悲观写锁防止并发冲突
  - 确保同一时间只有一个事务能修改余额

### 新增
- ✨ **钱包交易记录系统**
  - 新增 `wallet_transaction` 表记录所有余额变动
  - 记录交易前后余额、交易类型、关联订单等信息
  - 支持 6 种交易类型：支付、退款、充值、佣金、提现、调整

- ✨ **钱包服务 (WalletService)**
  - 统一的余额管理接口
  - `deductBalance` - 扣除余额（带事务和记录）
  - `addBalance` - 增加余额（带事务和记录）
  - `getBalance` - 查询余额
  - `getTransactions` - 查询交易记录
  - `getBalanceStatistics` - 查询余额统计

- ✨ **用户钱包接口**
  - `GET /user/wallet/balance` - 获取钱包余额
  - `GET /user/wallet/transactions` - 获取交易记录
  - `GET /user/wallet/statistics` - 获取余额统计

### 文档
- 📚 创建 [支付安全修复文档](./PAYMENT_SECURITY_FIX.md)
  - 详细说明修复的问题和方案
  - 技术实现细节
  - 测试建议
  - 性能影响分析
  - 监控建议

---

## [2025-01-11] - 文档体系完善

### 新增
- ✅ 创建举报模块 (Report Module)
  - 支持举报用户、文章、评论
  - 5种举报分类（垃圾信息、辱骂、不当内容、版权、其他）
  - 完整的举报处理流程
  - 举报统计功能
  - 防重复举报机制

### 文档
- 📚 创建完整的文档体系
  - [项目概览](./PROJECT_OVERVIEW.md) - 项目架构和功能说明
  - [数据库设计](./DATABASE.md) - 完整的数据表字段定义
  - [API 接口概览](./API_OVERVIEW.md) - 所有接口的快速参考
  - [字段快速参考](./FIELD_REFERENCE.md) - 枚举值和字段说明速查
  - [文档索引](./README.md) - 文档导航和使用指南
  - [举报模块文档](../src/modules/report/README.md) - 举报功能详细说明

### 改进
- 🔧 补齐所有实体的字段注释
- 📝 统一字段命名规范
- 🎨 优化文档结构和可读性

---

## 文档版本说明

### v1.0.0 (2025-01-11)
- 初始版本
- 包含所有核心模块的完整文档
- 数据库设计文档
- API 接口文档
- 字段参考文档

---

## 数据库变更

### 2025-01-11
- 新增 `report` 表 - 举报记录表
  - 支持举报用户、文章、评论
  - 包含举报分类、状态、处理结果等字段
  - 关联用户、文章、评论表

---

## API 变更

### 2025-01-11
- 新增举报相关接口
  - `POST /report` - 创建举报
  - `GET /report` - 获取举报列表
  - `GET /report/:id` - 获取举报详情
  - `PATCH /report/:id` - 更新举报状态
  - `DELETE /report/:id` - 删除举报记录
  - `GET /report/statistics` - 获取举报统计

---

## 模块说明

### 现有模块列表

#### 核心模块
1. **用户模块 (User)** - 用户管理、认证、关注系统
2. **角色模块 (Role)** - 角色管理
3. **权限模块 (Permission)** - 权限管理
4. **用户配置模块 (UserConfig)** - 用户个性化配置

#### 内容模块
5. **文章模块 (Article)** - 文章发布、管理
6. **评论模块 (Comment)** - 评论系统
7. **分类模块 (Category)** - 内容分类
8. **标签模块 (Tag)** - 内容标签
9. **文章点赞模块 (ArticleLike)** - 点赞和表情反应
10. **下载资源模块 (Download)** - 文章附件管理

#### 交易模块
11. **订单模块 (Order)** - 订单管理
12. **支付模块 (Payment)** - 支付处理

#### 社交模块
13. **邀请模块 (Invite)** - 邀请码和分成
14. **消息模块 (Message)** - 私信和通知
15. **举报模块 (Report)** - 内容举报 ⭐ 新增

#### 系统模块
16. **横幅模块 (Banner)** - 广告横幅
17. **系统配置模块 (Config)** - 系统配置
18. **上传模块 (Upload)** - 文件上传

---

## 技术栈

### 后端
- NestJS 11.x
- TypeScript 5.x
- TypeORM 0.3.x
- MySQL 8.0+

### 缓存
- Redis 6.0+
- Memory Cache

### 认证
- JWT (Access Token + Refresh Token)
- bcrypt 密码加密

### 实时通信
- Socket.IO (WebSocket)

### 文档
- Swagger/OpenAPI

### 第三方服务
- AWS S3 (文件存储)
- 支付宝 SDK
- 微信支付 SDK
- 邮件服务

---

## 开发规范

### 代码规范
- ESLint + Prettier
- TypeScript 严格模式
- 统一的命名规范

### 提交规范
- Conventional Commits
- Husky + lint-staged

### 模块结构
```
module/
├── entities/          # 实体定义
├── dto/              # 数据传输对象
├── *.controller.ts   # 控制器
├── *.service.ts      # 服务层
├── *.module.ts       # 模块定义
└── README.md         # 模块文档（可选）
```

---

## 待办事项

### 功能开发
- [ ] 通知系统优化
- [ ] 搜索功能增强
- [ ] 数据统计和分析
- [ ] 内容推荐算法
- [ ] 敏感词过滤

### 性能优化
- [ ] 数据库查询优化
- [ ] 缓存策略优化
- [ ] 图片压缩和CDN
- [ ] API 响应时间优化

### 安全加固
- [ ] 请求频率限制
- [ ] SQL 注入防护增强
- [ ] XSS 防护增强
- [ ] CSRF 防护

### 测试
- [ ] 单元测试覆盖率提升
- [ ] 集成测试
- [ ] E2E 测试
- [ ] 性能测试

### 文档
- [x] 数据库设计文档
- [x] API 接口文档
- [x] 字段参考文档
- [ ] 部署文档
- [ ] 运维文档
- [ ] 故障排查文档

---

## 已知问题

目前没有已知的严重问题。

---

## 贡献者

感谢所有为项目做出贡献的开发者！

---

## 许可证

UNLICENSED

---

**最后更新**: 2025-01-11
